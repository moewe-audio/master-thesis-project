//
// Created by Levin on 17.05.25.
//

#ifndef MODAL_H
#define MODAL_H

struct ModalMode {
    float f0;
    float Q;
};

struct ModalFilter {
    int       numModes;
    ModalMode model[];
};

struct Modal {
    double r,      cosθ, gain;
    double y1 = 0, y2 = 0;

    void init(double f0, double Q, double fs) {
        r        = exp(-M_PI * f0 / (Q * fs));
        double θ = 2 * M_PI * f0 / fs;
        cosθ     = cos(θ);
        // this ensures unity gain at f0:
        gain = (1.0 - r);
    }

    float process(float x) {
        // y[n] = 2⋅r⋅cosθ⋅y[n-1] − r²⋅y[n-2] + gain⋅x[n]
        double y0 = 2.0 * r * cosθ * y1
                    - r * r * y2
                    + gain * x;
        y2 = y1;
        y1 = y0;
        return (float) y0;
    }
};

static constexpr ModalFilter BANJO_FILTER{
    42,
    {
        {230.0024, 140.0000},
        {527.9516, 180.0000},
        {827.6603, 220.0000},
        {366.4722, 180.0000},
        {670.9851, 220.0000},
        {973.0113, 260.0000},
        {491.1814, 220.0000},
        {805.0425, 260.0000},
        {1111.3454, 300.0000},
        {610.2118, 260.0000},
        {933.5643, 300.0000},
        {1244.8005, 340.0000},
        {725.7646, 300.0000},
        {1058.2515, 340.0000},
        {1374.6189, 380.0000},
        {838.9227, 340.0000},
        {1180.0894, 380.0000},
        {1501.5968, 420.0000},
        {950.3099, 380.0000},
        {1299.7076, 420.0000},
        {1626.2802, 460.0000},
        {1060.3231, 420.0000},
        {1417.5365, 460.0000},
        {1749.0619, 500.0000},
        {1169.2329, 460.0000},
        {1533.8856, 500.0000},
        {1870.2359, 540.0000},
        {1277.2327, 500.0000},
        {1648.9856, 540.0000},
        {1990.0287, 580.0000},
        {1384.4665, 540.0000},
        {1763.0142, 580.0000},
        {2108.6189, 620.0000},
        {1491.0450, 580.0000},
        {1876.1113, 620.0000},
        {2226.1503, 660.0000},
        {1597.0548, 620.0000},
        {1988.3892, 660.0000},
        {2342.7410, 700.0000},
        {1702.5657, 660.0000},
        {2458.4887, 740.0000}
    }
};

static constexpr ModalFilter BANJO_FILTER_2{
    42,
    {
        {456.0048, 140.0000},
        {1046.7214, 180.0000},
        {1640.9265, 220.0000},
        {726.5710, 180.0000},
        {1330.3009, 220.0000},
        {1929.1007, 260.0000},
        {973.8206, 220.0000},
        {1596.0842, 260.0000},
        {2203.3631, 300.0000},
        {1209.8111, 260.0000},
        {1850.8926, 300.0000},
        {2467.9522, 340.0000},
        {1438.9072, 300.0000},
        {2098.0986, 340.0000},
        {2725.3313, 380.0000},
        {1663.2554, 340.0000},
        {2339.6555, 380.0000},
        {2977.0789, 420.0000},
        {1884.0926, 380.0000},
        {2576.8115, 420.0000},
        {3224.2772, 460.0000},
        {2102.2059, 420.0000},
        {2810.4202, 460.0000},
        {3467.7053, 500.0000},
        {2318.1313, 460.0000},
        {3041.0949, 500.0000},
        {3707.9460, 540.0000},
        {2532.2526, 500.0000},
        {3269.2933, 540.0000},
        {3945.4482, 580.0000},
        {2744.8554, 540.0000},
        {3495.3674, 580.0000},
        {4180.5661, 620.0000},
        {2956.1588, 580.0000},
        {3719.5945, 620.0000},
        {4413.5850, 660.0000},
        {3166.3348, 620.0000},
        {3942.1978, 660.0000},
        {4644.7387, 700.0000},
        {3375.5216, 660.0000},
        {4874.2211, 740.0000}
    }
};

#endif // MODAL_H
